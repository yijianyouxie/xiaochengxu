(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/index/cart"],{"2dee":function(t,i,e){"use strict";(function(t,o){Object.defineProperty(i,"__esModule",{value:!0}),i.default=void 0;var n=s(e("a963"));function s(t){return t&&t.__esModule?t:{default:t}}function a(t,i){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);i&&(o=o.filter((function(i){return Object.getOwnPropertyDescriptor(t,i).enumerable}))),e.push.apply(e,o)}return e}function r(t){for(var i=1;i<arguments.length;i++){var e=null!=arguments[i]?arguments[i]:{};i%2?a(Object(e),!0).forEach((function(i){c(t,i,e[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):a(Object(e)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))}))}return t}function c(t,i,e){return i in t?Object.defineProperty(t,i,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[i]=e,t}var d=t.database(),l={mixins:[n.default],data:function(){return{total:0,idList:[],idTotalList:{},amountList:{},timerId:null,selectIdKey:"mall_cart_select_ids",options:{ids:[]},shopDataList:{},dataList:[],emptyData:!0,isSelectAll:!1}},onLoad:function(){var t=this;o.$on("refreshCart",(function(){t.refreshData()}))},onPullDownRefresh:function(){console.log("刷新购物车整页"),o.stopPullDownRefresh(),this.refreshData()},onShow:function(){console.log("cart onShow"),this.refreshData()},computed:{btnDisenable:function(){return 0==this.options.ids.length}},methods:{refreshData:function(){var t=this;console.log("this.isLogin",this.isLogin),this.isLogin?d.action("goods_member,cart_goods").collection("opendb-mall-cart,opendb-mall-goods,opendb-mall-sku").where("user_id == $cloudEnv_uid").field("goods_id{_id as goods_id, name as goods_name,goods_thumb,price,market_price,is_vip,shop_id,remain_count as stock,is_real,is_on_sale,is_alone_sale,is_best,is_new,is_hot,use_score,use_score_rate},sku_id{_id as sku_id,sku_name,price,market_price,stock},price,goods_name,sku_name,amount,goods_thumb,update_date").orderBy("update_date desc").limit(200).get().then((function(i){var e=i.result;t.loadData(e.data),t.dataList=e.data})):this.loadData([])},loadData:function(t){var i=this,e=0;this.idList=[],this.shopDataList={};var n=o.getStorageSync(this.selectIdKey);this.options.ids=n||[],this.amountList={},this.isSelectAll=!1,this.emptyData=0==t.length,console.log("this.emptyData",this.emptyData);var s={};t.forEach((function(t){i.idList.push(t._id),i.idTotalList[t._id]=t.price*t.amount,i.amountList[t._id]=t.amount,t.name=t.goods_name?t.goods_name.substr(0,30):"",t.goods_thumb=i.$thumbImg(t.goods_thumb,"168x168"),t.stock<t.amount&&(t.subTitle="库存不足"),e+=t.amount,t.shop_id&&(s[t.shop_id]||(s[t.shop_id]=r(r({},t.shop),{},{children:[]})),s[t.shop_id].children.push(t))})),this.shopDataList=s,this.options.ids=this.options.ids.filter((function(t){return-1!=i.idList.indexOf(t)})),this.isSelectAll=this.options.ids.length==this.idList.length,this.$store.commit("mall/UPDATE_CART_NUMBER",+e),this.catTotal(),console.log("loadData",e,t)},navToDetail:function(t){this.navTo("/pages/product/detail?id=".concat(t.goods_id,"&sku=").concat(t.sku_id),r(r({},t),{},{sku_name:void 0,_id:t.goods_id}))},change:function(t){this.isSelectAll=t.detail.value.length==this.idList.length,this.options.ids=t.detail.value,this.catTotal(),o.setStorage({key:this.selectIdKey,data:this.options.ids})},changeAmount:function(t){if(this.isLogin){if(t.amount==this.amountList[t._id])return!1;this.$store.commit("mall/INCREMENT_CART_NUMBER",t.amount-this.amountList[t._id]),this.amountList[t._id]=+t.amount,d.collection("opendb-mall-cart").where({_id:t._id,user_id:d.env.uid}).update({amount:+t.amount}),this.catTotal()}},selectAll:function(){this.isSelectAll=!this.isSelectAll,this.isSelectAll?this.options.ids=this.idList:this.options.ids=[],this.catTotal(),o.setStorage({key:this.selectIdKey,data:this.options.ids})},catTotal:function(){var t=this,i=0;this.options.ids.map((function(e){i+=t.idTotalList[e]})),this.total=i},deletes:function(){var t=this;this.confirmAction((function(){t.$request("mall/cart/remove",{ids:t.options.ids},{loading:!0}).then((function(i){console.log(i),t.$success("删除成功"),t.refreshData()}))}),"是否确定删除？")},submit:function(){var t=this;0!=this.options.ids.length&&(this.dataList.filter((function(i){return-1!=t.options.ids.indexOf(i._id)&&i.stock<i.amount})).length>0?this.$message("商品库存不足"):(console.log("this.options.ids",this.options.ids),this.navTo("/pages/order/create",{type:"cart",cart_ids:this.options.ids,goodsList:this.dataList.filter((function(i){return-1!=t.options.ids.indexOf(i._id)}))})))}}};i.default=l}).call(this,e("a9ff")["default"],e("543d")["default"])},"66b4":function(t,i,e){},7334:function(t,i,e){"use strict";e.d(i,"b",(function(){return n})),e.d(i,"c",(function(){return s})),e.d(i,"a",(function(){return o}));var o={tianEmpty:function(){return e.e("uni_modules/tian-mall/components/tian-empty/tian-empty").then(e.bind(null,"2789"))},tianIcons:function(){return e.e("uni_modules/tian-mall/components/tian-icons/tian-icons").then(e.bind(null,"6439"))},tianGoodsPrice:function(){return e.e("uni_modules/tian-mall/components/tian-goods-price/tian-goods-price").then(e.bind(null,"956e"))}},n=function(){var t=this,i=t.$createElement,e=(t._self._c,t.__map(t.shopDataList,(function(i,e){var o=t.__get_orig(i),n=t.__map(i.children,(function(i,e){var o=t.__get_orig(i),n=t.options.ids.indexOf(i._id);return{$orig:o,g0:n}}));return{$orig:o,l0:n}})));t.$mp.data=Object.assign({},{$root:{l1:e}})},s=[]},baa6:function(t,i,e){"use strict";(function(t){e("566f");o(e("66fd"));var i=o(e("d66f"));function o(t){return t&&t.__esModule?t:{default:t}}wx.__webpack_require_UNI_MP_PLUGIN__=e,t(i.default)}).call(this,e("543d")["createPage"])},d56c:function(t,i,e){"use strict";var o=e("66b4"),n=e.n(o);n.a},d66f:function(t,i,e){"use strict";e.r(i);var o=e("7334"),n=e("f2ea");for(var s in n)"default"!==s&&function(t){e.d(i,t,(function(){return n[t]}))}(s);e("d56c");var a,r=e("f0c5"),c=Object(r["a"])(n["default"],o["b"],o["c"],!1,null,null,null,!1,o["a"],a);i["default"]=c.exports},f2ea:function(t,i,e){"use strict";e.r(i);var o=e("2dee"),n=e.n(o);for(var s in o)"default"!==s&&function(t){e.d(i,t,(function(){return o[t]}))}(s);i["default"]=n.a}},[["baa6","common/runtime","common/vendor"]]]);