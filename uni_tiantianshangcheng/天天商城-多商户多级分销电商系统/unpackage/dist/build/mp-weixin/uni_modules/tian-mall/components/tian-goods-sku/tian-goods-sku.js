(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["uni_modules/tian-mall/components/tian-goods-sku/tian-goods-sku"],{"5a97":function(e,t,i){"use strict";i.r(t);var n=i("c179"),s=i("a99e");for(var o in s)"default"!==o&&function(e){i.d(t,e,(function(){return s[e]}))}(o);i("cd1b");var u,a=i("f0c5"),r=Object(a["a"])(s["default"],n["b"],n["c"],!1,null,null,null,!1,n["a"],u);t["default"]=r.exports},"6a73":function(e,t,i){"use strict";(function(e,i){function n(e){return a(e)||u(e)||o(e)||s()}function s(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function o(e,t){if(e){if("string"===typeof e)return r(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(e,t):void 0}}function u(e){if("undefined"!==typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function a(e){if(Array.isArray(e))return r(e)}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,n=new Array(t);i<t;i++)n[i]=e[i];return n}function c(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function l(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?c(Object(i),!0).forEach((function(t){d(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):c(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function d(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var m=e.database(),h={data:function(){return{item:{},stock:0,loaded:!1,single:!1,amount:1,where:"",options:{},divider:"&gt;",selectSku:{},selectNames:"",submitButtonGroup:[{text:"确定",backgroundColor:"#ff0000",color:"#fff"}],skus:[],nameHash:[],skuNames:[],skuMap:{},skuNamesMap:{}}},props:{value:{type:Object,default:function(){return{price:0,market_price:0,member:{}}}},isSubmitSku:{type:Number,default:0},sid:{type:String,default:""},group_buying_id:{type:String,default:""}},watch:{value:function(e){this.item=e,this.skuNames=e.sku_name?e.sku_name:[],this.loadData()},group_buying_id:function(e){console.log("watch group_buying_id",e)}},created:function(){this.item=this.value,this.skuNames=this.value.sku_name?this.value.sku_name:[],this.loadData()},methods:{loadData:function(){var e=this;if(this.item&&this.item._id){if(this.single=!1,this.skuNamesMap={},this.loaded=!1,!this.item.sku_name||0==this.item.sku_name.length)return console.log("商品没有规格"),this.loaded=!0,this.single=!0,this.selectSku={price:this.item.price,stock:this.item.remain_count,market_price:this.item.market_price,goods_thumb:this.item.goods_thumb},void(this.stock=this.item.remain_count);this.isSelect=!1,this.selectSku={};var t={},i=[];this.amount=1,console.log("this.skuNames",this.skuNames),this.skuNames.map((function(e){t[e]=[]})),console.log("this.item",this.item),m.action("goods_skus").collection("opendb-mall-sku,opendb-mall-goods").where('goods_id._id=="'.concat(this.item._id,'"')).field("sku_name,price,market_price,shop_id,stock,goods_thumb,goods_id.use_score_rate,goods_id.use_score,goods_id.is_real,goods_id.is_vip,goods_id.name,goods_id.goods_thumb").limit(200).get().then((function(n){var s=n.result,o={},u=[];e.stock=0,s.data.map((function(n){""==n.goods_thumb?delete n.goods_thumb:n.goods_thumb&&(n.goods_thumb=e.$thumbImg(n.goods_thumb,"168x168"));var s=n.sku_name.split(e.divider);o[n.sku_name]=l(l(l({},e.item),n),{},{sku_name:s.join("+")}),e.stock+=n.stock,s.map((function(i,n){if(e.skuNames[n]&&t[e.skuNames[n]]){var s=t[e.skuNames[n]].findIndex((function(e){return e.name==i}));-1==s&&t[e.skuNames[n]].push({name:i,checked:!1,enable:!0})}})),e.sid==n._id&&(e.selectSku=o[n.sku_name],u=s,e.selectNames=s.join("，"),e.$emit("change",e.selectSku));for(var a=0;a<s.length-1;a++){var r=[s[a]];i.push(s[a]);for(var c=a+1;c<s.length;c++)i.push(s[c]),i.push([s[a],s[c]].sort().join(e.divider)),r.push(s[c]);i.push(r.sort().join(e.divider))}}));var a={};if(u.length>0){var r=function(e){t[e].forEach((function(t){t.checked=-1!=u.indexOf(t.name),t.checked&&(a[e]=t.name)}))};for(var c in t)r(c)}e.skuNamesMap=t,e.skuMap=o,e.nameHash=e.unique(i),u.length>0&&setTimeout((function(){e.checkSkuEnable(u,a)}),100),e.loaded=!0}))}else console.log("sku 没有商品id")},unique:function(e){for(var t=[],i=0;i<e.length;i++)-1==t.indexOf(e[i])&&t.push(e[i]);return t},close:function(){this.$refs.skuPopup.close()},change:function(e){var t=e.show;t?i.hideTabBar():i.showTabBar()},open:function(){this.$refs.skuPopup.open()},chooseSku:function(e,t,i){var s=this;if(!e.enable)return!1;e.checked=!e.checked,e.checked&&this.skuNamesMap[t].forEach((function(t){t.name!=e.name&&(t.checked=!1)}));var o=[],u=[],a={};for(var r in this.skuNamesMap){var c=this.skuNamesMap[r].filter((function(e){return e.checked}));c.length>0&&(o.push(c[0]),u.push(c[0].name),a[r]=c[0].name)}if(this.selectNames=u.join("，"),o.length==this.skuNames.length){var l=u.join(this.divider);this.selectSku=this.skuMap[l]}else this.selectSku={};var d=function(e){e!=t&&s.skuNamesMap[e].forEach((function(t){var i=u.filter((function(t){return t!=a[e]})),o=[].concat(n(i),[t.name]).sort().join(s.divider);t.enable=-1!=s.nameHash.indexOf(o)}))};for(var m in this.skuNamesMap)d(m);this.$emit("change",this.selectSku)},checkSkuEnable:function(e,t){for(var i=this,s=0;s<e.length;s++){var o=function(o){o!=s&&i.skuNamesMap[o].forEach((function(s){var u=e.filter((function(e){return e!=t[o]})),a=[].concat(n(u),[s.name]).sort().join(i.divider);s.enable=-1!=i.nameHash.indexOf(a)}))};for(var u in this.skuNamesMap)o(u)}},buttonClick:function(e){var t=this,n=e.index;if(console.log("buttonClick",n),this.checkBindMobile("必须绑定手机才能下单"))if(this.$store.getters["user/isTokenValid"])if(this.single||this.selectSku._id){if(!this.isSubmit)if(this.selectSku.stock<this.amount)this.$message("库存不足");else if(0==n)this.isSubmit=!0,i.showLoading({title:"请等待",mask:!0}),m.action("cart").collection("opendb-mall-cart").where({goods_id:this.item._id,sku_id:this.selectSku._id,user_id:m.env.uid}).update({goods_id:this.item._id,goods_name:this.selectSku.name,goods_thumb:this.selectSku.goods_thumb,shop_id:this.item.shop_id,sku_id:this.selectSku._id,sku_name:this.selectSku.sku_name,price:this.selectSku.price,market_price:this.selectSku.market_price,amount:+this.amount,user_id:m.env.uid}).then((function(e){var i=e.result;console.log("加入结果",i),i.updated?(t.$store.commit("mall/INCREMENT_CART_NUMBER",+t.amount),t.$success("加入成功")):t.$message("加入失败")})).catch((function(e){t.$message(e.message||"加入失败"),console.log("加入失败",e)})).finally((function(){t.isSubmitSku,t.close(),setTimeout((function(){t.isSubmit=!1}),1e3)}));else{this.close();var s=l(l({},this.selectSku),{},{goods_id:this.item._id,sku_id:this.selectSku._id,amount:this.amount});this.navTo("/pages/order/create",{type:"single",goods:[{group_buying:2==n,group_buying_id:this.group_buying_id,goods_id:this.item._id,sku_id:this.selectSku._id,amount:this.amount}],goodsList:[s]})}}else this.$message("请选择规格");else this.navToLoginNotice()}}};t.default=h}).call(this,i("a9ff")["default"],i("543d")["default"])},a723:function(e,t,i){},a99e:function(e,t,i){"use strict";i.r(t);var n=i("6a73"),s=i.n(n);for(var o in n)"default"!==o&&function(e){i.d(t,e,(function(){return n[e]}))}(o);t["default"]=s.a},c179:function(e,t,i){"use strict";i.d(t,"b",(function(){return s})),i.d(t,"c",(function(){return o})),i.d(t,"a",(function(){return n}));var n={uniPopup:function(){return i.e("uni_modules/uni-popup/components/uni-popup/uni-popup").then(i.bind(null,"36ef"))},tianGoodsPrice:function(){return i.e("uni_modules/tian-mall/components/tian-goods-price/tian-goods-price").then(i.bind(null,"956e"))},tianIcons:function(){return i.e("uni_modules/tian-mall/components/tian-icons/tian-icons").then(i.bind(null,"6439"))},uniLoadMore:function(){return Promise.all([i.e("common/vendor"),i.e("uni_modules/uni-load-more/components/uni-load-more/uni-load-more")]).then(i.bind(null,"458a"))},uniNumberBox:function(){return i.e("uni_modules/uni-number-box/components/uni-number-box/uni-number-box").then(i.bind(null,"68a0"))},tianGoodsNav:function(){return i.e("uni_modules/tian-mall/components/tian-goods-nav/tian-goods-nav").then(i.bind(null,"f750"))}},s=function(){var e=this,t=e.$createElement;e._self._c},o=[]},cd1b:function(e,t,i){"use strict";var n=i("a723"),s=i.n(n);s.a}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'uni_modules/tian-mall/components/tian-goods-sku/tian-goods-sku-create-component',
    {
        'uni_modules/tian-mall/components/tian-goods-sku/tian-goods-sku-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('543d')['createComponent'](__webpack_require__("5a97"))
        })
    },
    [['uni_modules/tian-mall/components/tian-goods-sku/tian-goods-sku-create-component']]
]);
